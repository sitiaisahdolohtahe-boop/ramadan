<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ramadan GPS Thailand</title>
<style>
body{
    margin:0;
    background:#05060d;
    color:white;
    font-family:sans-serif;
}
.container{
    position:absolute;
    top:30px;
    left:40px;
}
#countdown{
    position:absolute;
    bottom:120px;
    width:100%;
    text-align:center;
    font-size:50px;
}
button{
    padding:6px 10px;
    border:none;
    border-radius:5px;
    cursor:pointer;
}
</style>
</head>
<body>

<div class="container">
    <div id="location">Detecting location...</div><br>
    <div id="iftar"></div>
    <div id="suhoor"></div><br>
    <button onclick="getLocation()">Refresh GPS</button>
</div>

<div id="countdown"></div>

<script>

let maghribTime=null;
let fajrTime=null;
let currentMode="iftar";

/* ===== ดึงเวลาละหมาดจากพิกัดจริง ===== */
async function fetchPrayerTimes(lat,lon){
    let response = await fetch(
`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=99&school=0&fajr=18&isha=17`
    );

    let data = await response.json();

    maghribTime = data.data.timings.Maghrib.split(" ")[0];
    fajrTime    = data.data.timings.Fajr.split(" ")[0];

    document.getElementById("iftar").innerText =
        "Iftar (Maghrib): " + maghribTime;

    document.getElementById("suhoor").innerText =
        "Subuh (Fajr): " + fajrTime;
}

/* ===== แปลงพิกัดเป็นชื่อจังหวัด ===== */
async function reverseGeocode(lat,lon){
    let response = await fetch(
`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
    );

    let data = await response.json();

    let province =
        data.address.state ||
        data.address.province ||
        data.address.city ||
        "Thailand";

    document.getElementById("location").innerText =
        province + ", Thailand";
}

/* ===== ขอ GPS ===== */
function getLocation(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
            pos=>{
                let lat = pos.coords.latitude;
                let lon = pos.coords.longitude;

                fetchPrayerTimes(lat,lon);
                reverseGeocode(lat,lon);
            },
            error=>{
                alert("Location access denied ❌");
            }
        );
    }else{
        alert("Geolocation not supported");
    }
}

/* ===== Countdown ===== */
function getTarget(){
    let now=new Date();
    let target=new Date();

    if(currentMode==="iftar"){
        let [h,m]=maghribTime.split(":");
        target.setHours(h,m,0);
        if(now>=target){
            currentMode="suhoor";
            return getTarget();
        }
    }else{
        let [h,m]=fajrTime.split(":");
        target.setHours(h,m,0);
        if(now>=target){
            currentMode="iftar";
            return getTarget();
        }
    }

    if(now>target) target.setDate(target.getDate()+1);
    return target;
}

function updateCountdown(){
    if(!maghribTime||!fajrTime) return;

    let now=new Date();
    let target=getTarget();
    let diff=target-now;

    let h=Math.floor(diff/1000/60/60);
    let m=Math.floor(diff/1000/60%60);
    let s=Math.floor(diff/1000%60);

    document.getElementById("countdown").innerText=
        h.toString().padStart(2,"0")+":"+
        m.toString().padStart(2,"0")+":"+
        s.toString().padStart(2,"0");
}

setInterval(updateCountdown,1000);

/* ===== เริ่มทันที ===== */
getLocation();

</script>
</body>
</html>

